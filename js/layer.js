system42.on("apps:ready",(function(e){"use strict";e._apps.layer={categories:"Graphics;Viewer",icon:"apps/layer.png",accept:"image/*",uid:0,exec:function(e,n){if(!e)return $log("Usage: layer PATH"),void $log("e.g. : layer /c/files/images/emoticons/smiley-char023.gif");var t,o,a=this,i=this.le,r=this.app,c=new Image;function l(){c.onload=c.onerror=c.onabort=null,delete n.url;var l=n.onopen||$noop;delete n.onopen;var s,d,u,f=c.width,g=c.height,m="cover";(o=document.createElement("div")).style.background="url("+t+") no-repeat",o.style.backgroundSize=m,o.style.backgroundPosition="center",o.dataset.imageId=r.uid++,o.className="fullscreen js_image_inline cursor_cross";var h,y=[];function p(e){s=$fs.utils.getFolderPath(e),d=$fs.utils.getFileName(e),u=$io.obj.getPath(i._files,s,"/"),y=[],$io.obj.each(u,(function(e,n){/\.(bmp|gif|png|jpe?g|svg|ico|cur|tiff?)/.test(n)&&y.push(n)})),y.sort(),h=y.indexOf(d)}function v(e){var n=[];for(var t in e)e.hasOwnProperty(t)&&"object"==typeof e[t]&&n.push(t);return n[n.length*Math.random()<<0]}function b(e){var n=Object.keys(e);return n[n.length*Math.random()<<0]}function k(){if(h<0&&(h=y.length-1),h>y.length-1&&(h=0),d!==y[h]){d=y[h];var e=s+d;$url.checkImage(e,(function(n){n&&(o.style.background='url("'+e+'") no-repeat',o.style.backgroundSize=m,o.style.backgroundPosition="center",c.src=e)}))}}function w(){var e=v(i._files.c.files.images.gif.vj);p("c/files/images/vj/"+e+"/"+b(i._files.c.files.images.gif.vj[e]));var n=~~(Math.random()*y.length);h=n!==h?n:n+1,k()}p(t),window.$layer={prev:function(){h++,k()},next:function(){h++,k()},random:function(){var e=~~(Math.random()*y.length);h=e!==h?e:e+1,k()},randomFolder:w};var $,x=$loop(w),j=!0;$window.call(a,$extend({title:e,icon:n.icon||r.icon,header:!1,automaximize:!!n.fullscreen,contextmenu:{"after:FX":[{name:"---"},{name:"View",items:[{name:"Pixelated",key:"p",checkbox:!0,selected:!1,action:function(){console.log("pixelated"),o.classList.toggle("pixelated")}},{name:"---"},{name:"Cover",radio:"View",selected:!0,action:function(){m=o.style.backgroundSize="cover"}},{name:"Contain",radio:"View",action:function(){m=o.style.backgroundSize="contain"}},{name:"Fit",radio:"View",action:function(){m=o.style.backgroundSize="100% 100%"}},{name:"Scale",radio:"View",action:function(){m=o.style.backgroundSize="auto auto"}}]},{name:"Layer",items:[{name:"Previous",key:"left",action:function(){h--,k()}},{name:"Next",key:"right",action:function(){h++,k()}},{name:"Random",key:"up",action:function(){var e=~~(Math.random()*y.length);h=e!==h?e:e+1,k()}},{name:"Random Folder",key:"down",action:function(){var e=v(i._files.c.files.images.gif.vj);p("c/files/images/vj/"+e+"/"+b(i._files.c.files.images.gif.vj[e]));var n=~~(Math.random()*y.length);h=n!==h?n:n+1,k()}},{name:"---"},{name:"Duplicate",key:"ctrl+alt+space",action:function(){i._apps.layer.exec.call(a,e,n)}},{name:"Open Containing Folder",key:"ctrl+alt+enter",action:function(){$explorer(e)}}]},{name:"---"}]},contextmenuOnBody:j,baseClass:"ui_desktop_layer",bodyClass:"",borderTopWidth:0,borderBottomWidth:0,borderLeftWidth:0,borderRightWidth:0,height:g,width:f,html:o,onclose:function(){$&&$.destroy&&$.destroy(),x.destroy()},onactive:function(e,n){},ondrag:function(e,n,t){$key.shift&&i.canvas.draw(c,n,t)},onresize:function(e,n){},onready:function(e,t){var o=this;t.style.width="auto",t.style.height="auto",this.cfg.draggable&&($=$wheel.scale(e)),l.call(this,e,t),n.delay&&setTimeout((function(){o.close()}),n.delay)}},n))}$file.getUrl(e,(function(e){t=e,c.src=e})),c.onload=l,c.onerror=l,c.onabort=l}}}));